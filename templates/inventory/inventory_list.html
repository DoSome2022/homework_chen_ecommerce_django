<!-- templates/inventory/inventory_list.html -->
{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}库存查询{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/datatables.min.css' %}">
<style>
    .status-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    .table-actions {
        white-space: nowrap;
    }
    .low-stock {
        background-color: #fff3cd !important;
    }
    .critical-stock {
        background-color: #f8d7da !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">库存查询</h2>
        <div>
            <a href="{% url 'inventory:inventory_create' %}" class="btn btn-primary me-2">
                <i class="fas fa-plus"></i> 添加库存
            </a>
            <a href="{% url 'inventory:inventory_quick_add' %}" class="btn btn-success">
                <i class="fas fa-bolt"></i> 快速入库
            </a>
        </div>
    </div>

    <!-- 搜索表单 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">搜索过滤器</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="{{ search_form.product_name.id_for_label }}" class="form-label">产品名称</label>
                    {{ search_form.product_name }}
                </div>
                <div class="col-md-2">
                    <label for="{{ search_form.sku.id_for_label }}" class="form-label">SKU</label>
                    {{ search_form.sku }}
                </div>
                <div class="col-md-2">
                    <label for="{{ search_form.warehouse.id_for_label }}" class="form-label">仓库</label>
                    {{ search_form.warehouse }}
                </div>
                <div class="col-md-2">
                    <label for="{{ search_form.status.id_for_label }}" class="form-label">状态</label>
                    {{ search_form.status }}
                </div>
                <div class="col-md-2">
                    <label class="form-label d-block">&nbsp;</label>
                    <div class="form-check form-switch mt-2">
                        {{ search_form.low_stock }}
                        <label class="form-check-label" for="{{ search_form.low_stock.id_for_label }}">
                            仅显示低库存
                        </label>
                    </div>
                </div>
                <div class="col-md-1">
                    <label class="form-label d-block">&nbsp;</label>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> 搜索
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 库存统计 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">总库存价值</h5>
                            <h4 class="card-text">¥{{ total_value|default:0|floatformat:2 }}</h4>
                        </div>
                        <i class="fas fa-dollar-sign fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">总库存数量</h5>
                            <h4 class="card-text">{{ total_quantity|default:0 }}</h4>
                        </div>
                        <i class="fas fa-boxes fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">低库存产品</h5>
                            <h4 class="card-text">{{ low_stock_count|default:0 }}</h4>
                        </div>
                        <i class="fas fa-exclamation-triangle fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">仓库数量</h5>
                            <h4 class="card-text">{{ warehouse_count|default:0 }}</h4>
                        </div>
                        <i class="fas fa-warehouse fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 库存列表 -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">库存记录</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="inventoryTable">
                    <thead class="table-dark">
                        <tr>
                            <th>产品</th>
                            <th>SKU</th>
                            <th>仓库</th>
                            <th>库位</th>
                            <th>总数量</th>
                            <th>可用</th>
                            <th>预留</th>
                            <th>单位成本</th>
                            <th>状态</th>
                            <th>批次号</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in inventories %}
                        {% with product=item.product warehouse=item.warehouse %}
                        <tr class="{% if item.available_quantity <= 0 %}critical-stock{% elif item.available_quantity <= product.low_stock_threshold %}low-stock{% endif %}">
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if product.main_image %}
                                    <img src="{{ product.main_image.url }}" alt="{{ product.name }}" 
                                         class="me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                    {% endif %}
                                    <div>
                                        <strong>{{ product.name }}</strong><br>
                                        <small class="text-muted">{{ product.category.name|default:'未分类' }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <code>{{ product.sku }}</code>
                                {% if product.variants.exists %}
                                <span class="badge bg-info">多规格</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ warehouse.code }}</span><br>
                                <small>{{ warehouse.name }}</small>
                            </td>
                            <td>
                                {% if item.location %}
                                <span class="badge bg-dark">{{ item.location.code }}</span><br>
                                <small>{{ item.location.name }}</small>
                                {% else %}
                                <span class="text-muted">未指定</span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ item.quantity }}</strong>
                                {% if item.quantity <= product.low_stock_threshold %}
                                <br><small class="text-warning"><i class="fas fa-exclamation-triangle"></i> 低库存</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge {% if item.available_quantity > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ item.available_quantity }}
                                </span>
                            </td>
                            <td>
                                {% if item.reserved_quantity > 0 %}
                                <span class="badge bg-warning">{{ item.reserved_quantity }}</span>
                                {% else %}
                                <span class="text-muted">0</span>
                                {% endif %}
                            </td>
                            <td>¥{{ item.unit_cost|floatformat:2 }}</td>
                            <td>
                                {% if item.status == 'active' %}
                                <span class="badge bg-success status-badge">正常</span>
                                {% elif item.status == 'quarantine' %}
                                <span class="badge bg-warning status-badge">隔离</span>
                                {% elif item.status == 'damaged' %}
                                <span class="badge bg-danger status-badge">损坏</span>
                                {% elif item.status == 'expired' %}
                                <span class="badge bg-dark status-badge">过期</span>
                                {% elif item.status == 'reserved' %}
                                <span class="badge bg-info status-badge">预留</span>
                                {% else %}
                                <span class="badge bg-secondary status-badge">{{ item.get_status_display }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ item.batch_number|default:'-' }}</small><br>
                                {% if item.expiry_date %}
                                <small class="{% if item.is_expired %}text-danger{% else %}text-muted{% endif %}">
                                    到期: {{ item.expiry_date }}
                                </small>
                                {% endif %}
                            </td>
                            <td class="table-actions">
                                <a href="{% url 'inventory:inventory_detail' item.pk %}" 
                                   class="btn btn-sm btn-info" title="查看详情">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'inventory:inventory_update' item.pk %}" 
                                   class="btn btn-sm btn-warning" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'inventory:inventory_delete' item.pk %}" 
                                   class="btn btn-sm btn-danger" title="删除">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </td>
                        </tr>
                        {% endwith %}
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <h5>暂无库存记录</h5>
                                    <p>点击"添加库存"按钮创建第一条库存记录</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            {% if is_paginated %}
            <nav aria-label="库存记录分页">
                <ul class="pagination justify-content-center mt-4">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
    
    <!-- 导出功能 -->
    <div class="mt-3 text-end">
        <button class="btn btn-outline-secondary">
            <i class="fas fa-file-export"></i> 导出为Excel
        </button>
        <button class="btn btn-outline-secondary">
            <i class="fas fa-print"></i> 打印报告
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/datatables.min.js' %}"></script>
<script>
$(document).ready(function() {
    // 初始化DataTable
    $('#inventoryTable').DataTable({
        pageLength: 25,
        language: {
            url: '{% static "js/datatables-chinese.json" %}'
        },
        order: [[0, 'asc']],
        columnDefs: [
            { orderable: false, targets: 10 } // 禁用操作列排序
        ]
    });
    
    // 动态加载位置选项
    $('#id_warehouse').change(function() {
        var warehouseId = $(this).val();
        if (warehouseId) {
            $.get('/inventory/api/get-locations/', {warehouse_id: warehouseId}, function(data) {
                if (data.success) {
                    var $locationSelect = $('#id_location');
                    $locationSelect.empty();
                    $locationSelect.append($('<option>', {
                        value: '',
                        text: '选择位置...'
                    }));
                    $.each(data.locations, function(i, location) {
                        $locationSelect.append($('<option>', {
                            value: location.id,
                            text: location.code + ' - ' + location.name + 
                                  ' (可用: ' + location.available_volume + 'm³)'
                        }));
                    });
                }
            });
        }
    });
    
    // SKU自动完成
    $('#id_sku').autocomplete({
        source: function(request, response) {
            $.getJSON('/inventory/api/get-product/', {sku: request.term}, function(data) {
                if (data.success) {
                    response([{
                        label: data.product.name + ' (' + data.product.sku + ')',
                        value: data.product.sku
                    }]);
                } else {
                    response([]);
                }
            });
        },
        minLength: 2
    });
});
</script>
{% endblock %}